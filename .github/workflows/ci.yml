name: "Testing"

on:
  push:

permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  PUZZLE_SCRIPTS_DIR: crates/puzzle_path_tool/scripts/core
  DIFF_SCRIPTS_DIR_R: .local/diff-scripts
  LUA_LS_INSTALL_DIR_R: .local/lua-language-server
  EMMY_LUA_CS_INSTALL_DIR_R: .local/emmy-lua-code-style

jobs:
  rust_test:
    name: "Rust Test: [${{ matrix.arch.os }}/${{ matrix.arch.target }}] [${{ matrix.toolchain }}]"
    runs-on: "${{ matrix.arch.os }}-latest"
    strategy:
      matrix:
        arch:
          - ubuntu
          - { os: ubuntu, target: x86_64-unknown-linux-gnu }
          - { os: ubuntu, target: x86_64-unknown-linux-musl }
          - { os: ubuntu, target: aarch64-unknown-linux-gnu }
          - { os: windows, target: x86_64-pc-windows-msvc }
          - { os: macos, target: x86_64-apple-darwin }
          - { os: macos, target: aarch64-apple-darwin }
        toolchain:
          - stable
          - beta
          - nightly
    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: rustup update ${{ matrix.toolchain }} && rustup default ${{ matrix.toolchain }}

      - name: Build
        run: |
          cargo build --verbose --target ${{ matrix.arch.target }}
          tree target/

      - name: Test
        run: cargo test --verbose

  lua_lint:
    name: "Lua Linting"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

          LATEST=$(curl -s https://api.github.com/repos/LuaLS/lua-language-server/releases/latest | jq -r .tag_name)

          curl -L -o lls.tar.gz https://github.com/LuaLS/lua-language-server/releases/download/$LATEST/lua-language-server-$LATEST-linux-x64.tar.gz
          mkdir -p ~/$LUA_LS_INSTALL_DIR_R
          tar -xzf lls.tar.gz -C ~/$LUA_LS_INSTALL_DIR_R

          echo "$HOME/$LUA_LS_INSTALL_DIR_R/bin" >> $GITHUB_PATH

      - name: Generate Typedefs
        run: 'echo "TODO: Generate Typedefs"'

      - name: Check
        run: lua-language-server --check=.

  lua_format:
    name: "Lua Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

          LATEST=$(curl -s https://api.github.com/repos/CppCXY/EmmyLuaCodeStyle/releases/latest | jq -r .tag_name)

          curl -L -o elcs.tar.gz https://github.com/CppCXY/EmmyLuaCodeStyle/releases/download/$LATEST/linux-x64.tar.gz
          mkdir -p ~/$EMMY_LUA_CS_INSTALL_DIR_R
          file elcs.tar.gz
          tar -xzf elcs.tar.gz -C ~/$EMMY_LUA_CS_INSTALL_DIR_R --strip-components=1

          echo "$HOME/$EMMY_LUA_CS_INSTALL_DIR_R/bin" >> $GITHUB_PATH

      - name: Check Format
        run: |
          cp -a $PUZZLE_SCRIPTS_DIR ~/$DIFF_SCRIPTS_DIR_R
          CodeFormat format -c .editorconfig -w .
          git diff --no-index $PUZZLE_SCRIPTS_DIR/ ~/$DIFF_SCRIPTS_DIR_R/
